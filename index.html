<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>学習アプリ</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #eee;
    text-align: center;
    padding: 20px;
  }

  .hidden { display: none; pointer-events: none; }

#menu, #sorobanScreen, #addGameScreen {
  pointer-events: auto;
  position: relative;
  z-index: 1;
}

  button, input {
    font-size: 20px;
    padding: 10px 16px;
    margin: 8px;
  }

  input {
    width: 120px;
    text-align: center;
  }

  .value {
    font-size: 32px;
    margin: 20px 0;
  }

  .result {
    animation: pop 0.6s ease-out;
  }

  @keyframes pop {
    0% { transform: scale(0.8); opacity: 0; }
    60% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); }
  }

  .retry {
    font-size: 22px;
    margin-top: 20px;
  }

  /* ===== そろばん ===== */
  .soroban {
    display: flex;
    justify-content: center;
    background: #8d6e63;
    padding: 20px 25px;
    border-radius: 14px;
    gap: 6px;
  }

  .column { width: 90px; }

  .rod {
    position: relative;
    height: 300px;
  }

  .rod::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 0;
    width: 3px;
    height: 100%;
    background: #333;
    transform: translateX(-50%);
  }

  .beam {
    position: absolute;
    top: 120px;
    width: 100%;
    height: 8px;
    background: #4e342e;
  }

  .bead {
    position: absolute;
    left: 50%;
    width: 56px;
    height: 24px;
    transform: translateX(-50%);
    cursor: pointer;
    transition: top 0.15s;
    background: linear-gradient(to bottom,#ff8a65 0%,#ff7043 40%,#f4511e 60%,#ff7043 100%);
    border-radius: 50px;
    box-shadow: inset 0 3px 3px rgba(255,255,255,0.6), inset 0 -3px 3px rgba(0,0,0,0.25), 0 2px 2px rgba(0,0,0,0.3);
  }

  .upper { top: 30px; }
  .upper.active { top: 90px; }

  .b1 { top: 160px; }
  .b1.active { top: 130px; }
  .b2 { top: 190px; }
  .b2.active { top: 160px; }
  .b3 { top: 220px; }
  .b3.active { top: 190px; }
  .b4 { top: 250px; }
  .b4.active { top: 220px; }
</style>
</head>
<body>

<div id="menu">
  <h2>どれであそぶ？</h2>
  <button onclick="showSoroban()">そろばん</button>
  <button onclick="showAddGame()">たしざんゲーム</button>
</div>

<!-- ===== そろばん画面 ===== -->
<div id="sorobanScreen" class="hidden">
  <button onclick="backToMenu()">← もどる</button>
  <div class="value">いまの数：<span id="soroValue">0</span></div>
  <div class="soroban" id="soroban"></div>
</div>

<!-- ===== たしざんゲーム ===== -->
<div id="addGameScreen" class="hidden">
  <button onclick="backToMenu()">← もどる</button>
  <div class="value">のこり：<span id="time">60</span> 秒</div>
  <div class="value" id="question">1 + 1 = ?</div>
  <input id="answer" type="number" />
  <div class="value">せいかい：<span id="score">0</span></div>
</div>

<script>
  const menu = document.getElementById('menu');
  const sorobanScreen = document.getElementById('sorobanScreen');
  const addGameScreen = document.getElementById('addGameScreen');

  function backToMenu() {
    menu.classList.remove('hidden');
    sorobanScreen.classList.add('hidden');
    addGameScreen.classList.add('hidden');
    stopGame();
  }

  function showSoroban() {
    menu.classList.add('hidden');
    sorobanScreen.classList.remove('hidden');
  }

  function showAddGame() {
    menu.classList.add('hidden');
    sorobanScreen.classList.add('hidden');
    addGameScreen.classList.remove('hidden');
    startGame();
  }

  /* ===== たしざんゲーム ===== */
  let time = 60;
  let score = 0;
  let timer;
  let a = 0, b = 0;

  function newQuestion() {
    a = Math.floor(Math.random() * 9);
    b = Math.floor(Math.random() * 9);
    question.textContent = `${a} + ${b} = ?`;
    answer.value = '';
    answer.focus();
  }

  function startGame() {
    // 初期化
    addGameScreen.querySelectorAll('.retry').forEach(b => b.remove());
    answer.disabled = false;
    answer.disabled = false;
    time = 60;
    score = 0;
    timeSpan.textContent = time;
    scoreSpan.textContent = score;
    newQuestion();
    timer = setInterval(() => {
      time--;
      timeSpan.textContent = time;
      if (time <= 0) stopGame();
    }, 1000);
  }

  function stopGame() {
    clearInterval(timer);
    answer.disabled = true;

    const comments = score >= 25
      ? ['すごい！そろばんマスター！','天才！この調子！','完璧だね！']
      : score >= 15
      ? ['とてもよくできました！','いいペースだね！','ばっちり！']
      : score >= 5
      ? ['がんばったね！','つづけてみよう！','あと少し！']
      : ['だいじょうぶ！','つぎはもっとできるよ','ゆっくりでOK！'];

    const comment = comments[Math.floor(Math.random() * comments.length)];

    question.innerHTML = `<div class="result">おわり！<br>正解 ${score} 問<br>${comment}</div>`;

    const retry = document.createElement('button');
    retry.textContent = 'もう一回やる';
    retry.className = 'retry';
    retry.onclick = () => {
      retry.remove();
      startGame();
    };
    question.after(retry);
  } 問`; 
    const c = document.createElement('div');
    c.className = 'value';
    c.textContent = comment;
    question.after(c);
  }

  const question = document.getElementById('question');
  const answer = document.getElementById('answer');
  let composing = false; // IME入力中フラグ
  const timeSpan = document.getElementById('time');
  const scoreSpan = document.getElementById('score');

  answer.addEventListener('compositionstart', () => {
    composing = true;
  });

  answer.addEventListener('compositionend', () => {
    composing = false;
  });

  answer.addEventListener('compositionstart', () => composing = true);
answer.addEventListener('compositionend', () => composing = false);

answer.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  if (composing || answer.disabled) return;

  const v = answer.value
    .replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248))
    .replace(/[^0-9]/g, '');

  if (parseInt(v, 10) === a + b) {
    score++;
    scoreSpan.textContent = score;
    okSound.currentTime = 0; okSound.play();
  } else {
    ngSound.currentTime = 0; ngSound.play();
  }
  newQuestion();
});

      if (parseInt(v, 10) === a + b) {
        score++;
        scoreSpan.textContent = score;
      }
      newQuestion();
    }
  }); // 全角半角混在対応
      if (parseInt(v, 10) === a + b) {
        score++;
        scoreSpan.textContent = score;
      }
      newQuestion();
    }
  });

  /* ===== そろばん（20パターン完全一致） ===== */
  const soroban = document.getElementById('soroban');
  const soroValue = document.getElementById('soroValue');

  const state = [
    { upper:false, lower:0 },
    { upper:false, lower:0 }
  ];

  function nextLower(current, pressed) {
    // 20パターンを厳密に表にして処理
    const table = {
      0: {1:1, 2:2, 3:3, 4:4},
      1: {1:0, 2:2, 3:3, 4:4},
      2: {1:0, 2:1, 3:3, 4:4},
      3: {1:0, 2:1, 3:2, 4:4},
      4: {1:0, 2:1, 3:2, 4:3}
    };
    return table[current][pressed];
  }

  function renderSoroban() {
    soroban.innerHTML = '';
    let total = 0;

    state.forEach((st, ci) => {
      const col = document.createElement('div');
      col.className = 'column';
      const rod = document.createElement('div');
      rod.className = 'rod';
      rod.innerHTML = '<div class="beam"></div>';

      const upper = document.createElement('div');
      upper.className = 'bead upper' + (st.upper ? ' active' : '');
      upper.onclick = () => { st.upper = !st.upper; renderSoroban(); };
      rod.appendChild(upper);

      for (let i = 1; i <= 4; i++) {
        const b = document.createElement('div');
        b.className = 'bead b' + i + (i <= st.lower ? ' active' : '');
        b.onclick = () => {
          st.lower = nextLower(st.lower, i);
          if (st.lower < 0) st.lower = 0;
          renderSoroban();
        };
        rod.appendChild(b);
      }

      col.appendChild(rod);
      soroban.appendChild(col);

      const mul = ci === 0 ? 10 : 1;
      total += (st.upper ? 5 : 0) * mul + st.lower * mul;
    });

    soroValue.textContent = total;
  }

  renderSoroban();
</script>

</body>
</html>
